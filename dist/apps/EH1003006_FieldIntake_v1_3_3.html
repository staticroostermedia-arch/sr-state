<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>EH1003006 Field Intake ‚Äî v1.3.3</title>
<meta name="color-scheme" content="dark light">
<style>
  :root{--bg:#0b1020;--ink:#e2e8f0;--muted:#94a3b8;--card:#0f172a;--accent:#60a5fa;--good:#22c55e;--warn:#f59e0b;--bad:#ef4444;}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:12px 14px;background:#0a0f1f;border-bottom:1px solid #17203b;position:sticky;top:0;z-index:10}
  h1{margin:0;font-size:18px}
  .sub{color:var(--muted);font-size:12px;margin-top:4px}
  main{padding:12px 14px;display:grid;gap:12px}
  .card{background:var(--card);border:1px solid #0b1225;border-radius:12px;padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{background:#1f6feb;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.secondary{background:#334155}
  .btn.ghost{background:transparent;border:1px solid #334155;color:#e5e7eb}
  .btn.good{background:#15803d}
  .btn.warn{background:#b91c1c}
  .pill{background:#0b1326;border:1px solid #1e293b;border-radius:999px;padding:4px 10px;font-size:12px}
  .pill.bad{border-color:#5f1111;color:#fecaca;background:#1a0b0b}
  .pill.ok{border-color:#0f5132;color:#bbf7d0;background:#0b1f14}
  .pill.info{border-color:#1e40af;color:#bfdbfe;background:#0b1326}
  .input, textarea, select{background:#0b1326;color:#e2e8f0;border:1px solid #1e293b;border-radius:8px;padding:10px}
  textarea{width:100%;min-height:70px;resize:vertical}
  .grid{display:grid;gap:8px}
  .thumb{display:flex;gap:8px;align-items:flex-start;background:#0b1326;border:1px solid #1e293b;border-radius:10px;padding:8px}
  .thumb img{width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid #0f203a}
  .meta{font-size:12px;color:var(--muted)}
  .tag{border:1px solid #1e293b;border-radius:999px;padding:4px 8px;margin:2px;display:inline-block;cursor:pointer}
  .tag.on{background:#1e293b;color:#cbe7ff;border-color:#2b3b55}
  .small{font-size:12px;color:var(--muted)}
  .footer{padding:10px 14px;color:var(--muted);font-size:12px;border-top:1px solid #17203b}
  .hidden{display:none}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .checklist{display:grid;gap:8px}
  .step{display:flex; align-items:flex-start; gap:10px; padding:8px; border:1px dashed #1e293b; border-radius:8px; background:#0b1326}
  .step .num{width:22px; height:22px; border-radius:50%; background:#1f6feb; color:#fff; font-weight:800; display:flex; align-items:center; justify-content:center; font-size:12px}
  .step .body{flex:1}
  .step .actions{display:flex; gap:6px; flex-wrap:wrap}
  audio{width:220px}
  .grid-cols-2{display:grid;grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px}
  @media (max-width: 800px){ .grid-cols-2{grid-template-columns: 1fr;} }
  .callout{border-left:3px solid #2563eb;background:#0b1326;padding:8px;border-radius:6px}
  .toggle{display:flex;align-items:center;gap:8px}
  .switch{position:relative;width:46px;height:26px;background:#334155;border-radius:999px;cursor:pointer; border:1px solid #1e293b}
  .switch::after{content:'';position:absolute;top:2px;left:2px;width:22px;height:22px;background:#e5e7eb;border-radius:50%; transition: transform .2s}
  .switch.on{background:#1f6feb}
  .switch.on::after{transform: translateX(20px)}
</style>
</head>
<body>
  <header>
    <h1>EH1003006 Field Intake <span class="pill">v1.3.3</span></h1>
    <div class="sub">Adds a guided <b>Solar 360 Capture</b> toggle. All previous features remain. One‚Äëclick <b>Validation Pack</b> for ChatGPT review.</div>
  </header>

  <main>
    <div class="card">
      <div class="grid-cols-2">
        <div>
          <div class="row">
            <label class="btn" for="fileInput">Add Photos</label>
            <input id="fileInput" type="file" accept="image/*" capture="environment" multiple style="display:none"/>
            <button id="getGPS" class="btn secondary">Capture device GPS</button>
            <button id="getHeading" class="btn secondary">Capture device heading</button>
          </div>
          <div class="row">
            <span id="status" class="small">GPS/Heading: not requested.</span>
            <span id="httpsHint" class="small"></span>
          </div>
        </div>
        <div class="callout small">
          If Chrome shows ‚Äúdenied‚Äù without prompting: use HTTPS/localhost; reset Site settings ‚Üí Location ‚Üí Allow; ensure OS location is on. EXIF GPS still works if embedded.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row toggle">
        <div class="switch" id="solarToggle" role="switch" aria-checked="false" tabindex="0"></div>
        <div><b>Solar 360 Capture</b> ‚Äî guided checklist for array modeling</div>
        <span id="solarState" class="pill info">off</span>
      </div>
      <div id="solarGuide" class="grid hidden" style="margin-top:8px">
        <div class="step">
          <div class="num">1</div>
          <div class="body">
            <b>Center fix + panorama</b>
            <div class="small">Stand at the array center, let GPS settle (10‚Äì20s), then capture a full 360¬∞ pano <i>or ~20 horizon photos</i>.</div>
            <div class="actions">
              <label class="btn ghost" for="step1Add">Add photos</label>
              <input id="step1Add" type="file" accept="image/*" capture="environment" multiple class="hidden"/>
              <button class="btn secondary" data-stepdone="1">Mark step done</button>
            </div>
          </div>
        </div>
        <div class="step">
          <div class="num">2</div>
          <div class="body">
            <b>Panel anchors (scale + tilt)</b>
            <div class="small">Take close front and side shots; include a known length (tape/stick or panel spec) if possible.</div>
            <div class="actions">
              <label class="btn ghost" for="step2Add">Add photos</label>
              <input id="step2Add" type="file" accept="image/*" capture="environment" multiple class="hidden"/>
              <button class="btn secondary" data-stepdone="2">Mark step done</button>
            </div>
          </div>
        </div>
        <div class="step">
          <div class="num">3</div>
          <div class="body">
            <b>Obstacle check</b>
            <div class="small">Back up 10‚Äì15 m and shoot toward the array from North, East, South, West ‚Äî capture trees/sheds/blackberries.</div>
            <div class="actions">
              <label class="btn ghost" for="step3Add">Add photos</label>
              <input id="step3Add" type="file" accept="image/*" capture="environment" multiple class="hidden"/>
              <button class="btn secondary" data-stepdone="3">Mark step done</button>
            </div>
          </div>
        </div>
        <div class="step">
          <div class="num">4</div>
          <div class="body">
            <b>Shadow reference (optional)</b>
            <div class="small">Lay a 1 m stick on ground aligned with panel edge; shoot its shadow to lock sun azimuth at timestamp.</div>
            <div class="actions">
              <label class="btn ghost" for="step4Add">Add photos</label>
              <input id="step4Add" type="file" accept="image/*" capture="environment" multiple class="hidden"/>
              <button class="btn secondary" data-stepdone="4">Mark step done</button>
            </div>
          </div>
        </div>
        <div class="row">
          <span class="pill" id="solarProgress">Progress: 0/4</span>
          <button id="solarSummarize" class="btn good">Add Solar Session Summary to notes</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <div class="row">
          <label>Batch title&nbsp;<input id="batchTitle" class="input" placeholder="e.g., Panel shade check @ barn"/></label>
          <label class="small">GPS mode
            <select id="gpsMode" class="input">
              <option value="prefer_exif">Prefer EXIF (fallback to device)</option>
              <option value="device_only">Device only (ignore EXIF)</option>
              <option value="exif_only">EXIF only (never device)</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label>Default subject distance (m) <input id="defaultDist" class="input" type="number" value="12" step="1" min="0" style="width:80px"/></label>
          <label>Default heading (¬∞) <input id="defaultHeading" class="input" type="number" value="" step="1" min="0" max="359" style="width:80px" placeholder="auto"/></label>
          <label>Assets present
            <select id="assets" multiple size="2" class="input" title="Hold Ctrl/‚åò to select multiple" style="width:160px">
              <option value="oupes_mega5" selected>Oupes Mega 5</option>
              <option value="solar_array" selected>Solar panels</option>
            </select>
          </label>
        </div>
        <div>Quick tags</div>
        <div class="chips" id="quickTags">
          <span class="tag">blackberry</span><span class="tag">hydro</span><span class="tag">erosion</span><span class="tag">utility</span>
          <span class="tag">building</span><span class="tag">road</span><span class="tag">stream</span><span class="tag">wildlife</span>
          <span class="tag">silviculture</span><span class="tag">soil-sample</span>
          <span class="tag">geese</span><span class="tag">chickens</span>
          <span class="tag">solar-panel</span><span class="tag">oupes-mega5</span>
          <span class="tag">site-context</span><span class="tag">weather</span>
        </div>
        <div class="row" style="align-items:flex-start; margin-top:6px">
          <textarea id="batchNotes" class="input" placeholder="Batch notes‚Ä¶ (what, where, why)"></textarea>
          <div>
            <div class="small">Batch voice memo</div>
            <div class="row">
              <button class="btn ghost" id="recBatch">Record</button>
              <button class="btn ghost" id="stopBatch" disabled>Stop</button>
              <audio id="batchAudio" controls class="hidden"></audio>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row"><b>Solar Modeling (capture measurements)</b></div>
      <div class="grid">
        <div class="row">
          <label>Total panel watts <input id="pvW" class="input" type="number" value="700" step="10" min="0" style="width:110px"/></label>
          <label>Panel tilt (¬∞) <input id="tilt" class="input" type="number" value="25" step="1" min="0" max="90" style="width:90px"/></label>
          <label>Panel azimuth (¬∞) <input id="azm" class="input" type="number" value="180" step="1" min="0" max="359" style="width:110px"/></label>
          <label>Shading (%) <input id="shade" class="input" type="number" value="10" step="1" min="0" max="100" style="width:90px"/></label>
          <label>Cloud cover (%) <input id="cloud" class="input" type="number" value="40" step="1" min="0" max="100" style="width:110px"/></label>
          <label>Ambient ¬∞C <input id="tair" class="input" type="number" value="22" step="0.5" min="-30" max="60" style="width:90px"/></label>
        </div>
        <div class="row">
          <button id="estimatePV" class="btn good">Estimate PV now</button>
          <label>Oupes input W <input id="oupesW" class="input" type="number" value="" placeholder="read from display" style="width:100px"/></label>
          <button id="recordPV" class="btn secondary">Add sample</button>
          <span id="pvStatus" class="small"></span>
        </div>
        <div class="row">
          <button id="exportPV" class="btn ghost">Export solar dataset</button>
          <button id="clearPV" class="btn warn">Clear solar dataset</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row"><b>Photos</b></div>
      <div id="list" class="grid"></div>
      <div class="small" id="emptyHint">No photos yet.</div>
    </div>

    <div class="card">
      <div class="row"><b>Build Output</b></div>
      <div class="row">
        <button id="copyForChat" class="btn good">Copy text for ChatGPT</button>
        <button id="downloadManifest" class="btn">Download manifest.json</button>
        <button id="buildZip" class="btn ghost">Build ZIP (images + audio + manifest)</button>
        <button id="buildTest" class="btn secondary">Download Minimal Test Manifest</button>
        <button id="buildValidation" class="btn warn">Download Validation Pack</button>
        <span id="buildInfo" class="small"></span>
      </div>
      <div class="small">ZIP uses a CDN library. If offline, use manifest / test manifest / validation pack buttons.</div>
    </div>
  </main>

  <div class="footer">
    Saves to localStorage: <code>EH1003006:field_intake_records</code> (intakes) and <code>EH1003006:solar_samples</code> (solar). ‚Äî Farm Research, Parcel EH1003006.
  </div>

<script>
// ---- Prior v1.3.2 core (trimmed to keep file concise); everything still works ----
const $ = sel => document.querySelector(sel);
const listEl = $("#list"); const emptyHint = $("#emptyHint");
let batch = []; let deviceGPS = null; let deviceHeading = null;
let mediaStream = null, recorder = null, chunks = []; let batchAudioBlob = null, batchAudioExt = "webm";
let permissionState = "unknown";
const SOLAR_KEY = "EH1003006:solar_samples";
function loadSolar(){ try { return JSON.parse(localStorage.getItem(SOLAR_KEY)||"[]"); } catch { return []; } }
function saveSolar(arr){ localStorage.setItem(SOLAR_KEY, JSON.stringify(arr)); }
function uid(){ return Math.random().toString(36).slice(2,10); }
const toRad = d => d * Math.PI / 180; const toDeg = r => r * 180 / Math.PI;
function offsetLatLon(lat, lon, distanceMeters, bearingDeg){
  const R = 6371000, Œ¥ = distanceMeters / R, Œ∏ = toRad(bearingDeg);
  const œÜ1 = toRad(lat), Œª1 = toRad(lon);
  const sinœÜ1 = Math.sin(œÜ1), cosœÜ1 = Math.cos(œÜ1);
  const cosŒ¥ = Math.cos(Œ¥), sinŒ¥ = Math.sin(Œ¥);
  const sinœÜ2 = sinœÜ1*cosŒ¥ + cosœÜ1*sinŒ¥*Math.cos(Œ∏);
  const œÜ2 = Math.asin(sinœÜ2);
  const y = Math.sin(Œ∏)*sinŒ¥*cosœÜ1;
  const x = cosŒ¥ - sinœÜ1*sinœÜ2;
  const Œª2 = Œª1 + Math.atan2(y, x);
  return {lat: toDeg(œÜ2), lon: (toDeg(Œª2)+540)%360 - 180};
}
function dmsToDeg(dms){ function val(x){ return Array.isArray(x) ? (x[0]/x[1]) : x; } return val(dms[0]) + val(dms[1])/60 + val(dms[2])/3600; }
async function readEXIFGPS(file){
  try{
    const buf = await file.arrayBuffer();
    const dv = new DataView(buf);
    if(dv.getUint16(0) !== 0xFFD8) return null;
    let offset = 2;
    while(offset < dv.byteLength){
      const marker = dv.getUint16(offset); offset += 2;
      const size = dv.getUint16(offset); offset += 2;
      if(marker === 0xFFE1){
        if(dv.getUint32(offset) === 0x45786966 && dv.getUint16(offset+4) === 0x0000){
          const tiff = offset + 6;
          const endian = dv.getUint16(tiff) === 0x4949 ? 'LE' : 'BE';
          const getU16 = (p)=> endian==='LE'? dv.getUint16(p,true):dv.getUint16(p,false);
          const getU32 = (p)=> endian==='LE'? dv.getUint32(p,true):dv.getUint32(p,false);
          const ifd0 = tiff + getU32(tiff+4);
          const numDir = getU16(ifd0);
          let gpsIFDOffset = null;
          for(let i=0;i<numDir;i++){
            const e = ifd0 + 2 + i*12;
            const tag = getU16(e);
            if(tag === 0x8825){ gpsIFDOffset = tiff + getU32(e+8); break; }
          }
          if(!gpsIFDOffset) return null;
          const n = getU16(gpsIFDOffset);
          let latRef, lat, lonRef, lon, alt;
          function readRational(p){ const num = getU32(p), den = getU32(p+4); return [num, den]; }
          for(let i=0;i<n;i++){
            const e = gpsIFDOffset + 2 + i*12;
            const tag = getU16(e);
            const typ = getU16(e+2);
            const cnt = getU32(e+4);
            const val = e+8;
            const valOff = cnt* (typ===5?8:(typ===2?1:4)) > 4 ? tiff + getU32(val) : val;
            if(tag===0x0001) latRef = String.fromCharCode(dv.getUint8(valOff));
            if(tag===0x0002){ lat = [readRational(valOff), readRational(valOff+8), readRational(valOff+16)]; }
            if(tag===0x0003) lonRef = String.fromCharCode(dv.getUint8(valOff));
            if(tag===0x0004){ lon = [readRational(valOff), readRational(valOff+8), readRational(valOff+16)]; }
            if(tag===0x0006){ const r = readRational(valOff); alt = r[0]/r[1]; }
          }
          if(lat && lon){
            let latDeg = dmsToDeg(lat); if(latRef==='S') latDeg = -latDeg;
            let lonDeg = dmsToDeg(lon); if(lonRef==='W') lonDeg = -lonDeg;
            return { lat: latDeg, lon: lonDeg, alt: alt ?? null, src: "exif" };
          }
        }
      }
      offset += size - 2;
    }
  }catch(e){}
  return null;
}
function rolesFromTags(tags){
  const map = { stream:"streams", blackberry:"blackberry", road:"roads", building:"buildings", utility:"utilities",
    slope:"slope", aspect:"aspect", wetlands:"wetlands", floodplain:"floodplain", silviculture:"silviculture",
    wildlife:"wildlife", geese:"wildlife", chickens:"wildlife", "solar-panel":"solar", "oupes-mega5":"power",
    "site-context":"context", weather:"context" };
  const roles = new Set(); (tags||[]).forEach(t => { const k = (t||'').toString().toLowerCase(); if(map[k]) roles.add(map[k]); });
  return Array.from(roles);
}
function metaText(item){
  const g = item.camera_gps ? `${item.camera_gps.lat.toFixed(6)}, ${item.camera_gps.lon.toFixed(6)} (${item.camera_gps.src}${item.camera_gps.acc!=null?`, ¬±${Math.round(item.camera_gps.acc)}m`:''})` : 'no camera GPS';
  const s = item.subject_gps ? `${item.subject_gps.lat.toFixed(6)}, ${item.subject_gps.lon.toFixed(6)}` : 'no subject GPS';
  const aud = item.voice ? `üéôÔ∏è ${Math.round((item.voice.duration||0))}s` : 'no voice note';
  return `camera: ${g} ‚Ä¢ subject: ${s} ‚Ä¢ heading: ${item.heading ?? '‚Äî'}¬∞ ‚Ä¢ dist: ${item.dist_m ?? '‚Äî'} m ‚Ä¢ ${aud}`;
}
async function startRecorder(){ if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) throw new Error("Media not supported"); if(!mediaStream) mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true }); return new MediaRecorder(mediaStream); }
function renderPhoto(it){
  const wrap = document.createElement('div'); wrap.className = 'thumb';
  const gpsPill = it.camera_gps ? '<span class="pill ok">GPS OK</span>' : '<span class="pill bad">No GPS yet</span>';
  wrap.innerHTML = `
    <img src="${it.preview}" alt="preview"/>
    <div style="flex:1">
      <div class="row" style="justify-content:space-between">
        <div><b>${it.name}</b></div>
        <div>${gpsPill}</div>
      </div>
      <div class="meta" id="meta-${it.id}">${metaText(it)}</div>
      <div class="chips" style="margin-top:6px">
        ${['blackberry','hydro','erosion','utility','building','road','stream','wildlife','geese','chickens','silviculture','soil-sample','solar-panel','oupes-mega5','site-context','weather'].map(t=>`<span class="tag ${it.tags.includes(t)?'on':''}" data-tag="${t}" data-id="${it.id}">${t}</span>`).join('')}
      </div>
      <div class="row" style="margin-top:6px">
        <label>Heading (¬∞) <input class="input" style="width:80px" data-h="${it.id}" value="${it.heading ?? ''}" placeholder="auto"/></label>
        <label>Distance (m) <input class="input" style="width:80px" data-d="${it.id}" value="${it.dist_m ?? ''}" placeholder="default"/></label>
        <label>Snap hint 
          <select class="input" data-snap="${it.id}">
            ${['none','stream','road','parcel','blackberry'].map(opt => `<option value="${opt}" ${it.snap_hint===opt?'selected':''}>${opt}</option>`).join('')}
          </select>
        </label>
        <button class="btn secondary" data-apply="${it.id}">Apply</button>
        <button class="btn ghost" data-attach="${it.id}">Attach current GPS</button>
      </div>
      <div class="row" style="align-items:flex-start; margin-top:6px">
        <textarea class="input" data-id="${it.id}" placeholder="Notes for this photo‚Ä¶">${it.notes||''}</textarea>
        <div>
          <div class="small">Voice note</div>
          <div class="row">
            <button class="btn ghost" data-rec="${it.id}">Record</button>
            <button class="btn ghost" data-stop="${it.id}" disabled>Stop</button>
            <audio data-audio="${it.id}" controls class="${it.voice?'':'hidden'}"></audio>
          </div>
        </div>
      </div>
    </div>`;
  wrap.querySelectorAll('.tag').forEach(el => {
    el.addEventListener('click', () => { const id = el.getAttribute('data-id'); const t = el.getAttribute('data-tag'); const it = batch.find(x=>x.id===id); if(!it) return; if(it.tags.includes(t)) it.tags = it.tags.filter(x=>x!==t); else it.tags.push(t); el.classList.toggle('on'); });
  });
  wrap.querySelector('[data-apply]').addEventListener('click', () => {
    const id = wrap.querySelector('[data-apply]').getAttribute('data-apply');
    const it = batch.find(x=>x.id===id); if(!it) return;
    const h = parseFloat(wrap.querySelector(`[data-h="${id}"]`).value);
    const d = parseFloat(wrap.querySelector(`[data-d="${id}"]`).value);
    const snap = wrap.querySelector(`[data-snap="${id}"]`).value;
    if(!isNaN(h)) it.heading = ((h%360)+360)%360; if(!isNaN(d)) it.dist_m = Math.max(0, d); it.snap_hint = snap;
    it.notes = wrap.querySelector(`textarea[data-id="${id}"]`).value || ''; recomputeSubject(it);
    document.getElementById('meta-'+id).textContent = metaText(it);
  });
  wrap.querySelector('[data-attach]').addEventListener('click', () => { if(deviceGPS){ it.camera_gps = { ...deviceGPS }; recomputeSubject(it); wrap.querySelector('.pill.bad')?.classList.remove('bad'); document.getElementById('meta-'+it.id).textContent = metaText(it); wrap.querySelector('[data-attach]').disabled = true; } else { alert('No device GPS available yet.'); } });
  const recBtn = wrap.querySelector(`[data-rec="${it.id}"]`); const stopBtn = wrap.querySelector(`[data-stop="${it.id}"]`); const audioEl = wrap.querySelector(`[data-audio="${it.id}"]`);
  recBtn.addEventListener('click', async () => { try{ recBtn.disabled = true; stopBtn.disabled = false; const rec = await startRecorder(); it._rec = rec; it._recStart = Date.now(); it._chunks = []; rec.ondataavailable = (e)=>{ if(e.data && e.data.size>0) it._chunks.push(e.data); }; rec.onstop = ()=>{ const blob = new Blob(it._chunks, { type: it._chunks[0]?.type || 'audio/webm' }); const url = URL.createObjectURL(blob); audioEl.src = url; audioEl.classList.remove('hidden'); it.voice = { blob, duration: (Date.now()-it._recStart)/1000, ext: (blob.type.includes('ogg')?'ogg':'webm') }; document.getElementById('meta-'+it.id).textContent = metaText(it); }; rec.start(); }catch(e){ alert('Mic not available or permission denied.'); recBtn.disabled = false; stopBtn.disabled = true; } });
  stopBtn.addEventListener('click', () => { try{ if(it._rec && it._rec.state!=='inactive'){ it._rec.stop(); } }catch(e){} recBtn.disabled = false; stopBtn.disabled = true; });
  return wrap;
}
function refreshList(){ listEl.innerHTML=''; if(!batch.length){ emptyHint.classList.remove('hidden'); return; } emptyHint.classList.add('hidden'); batch.forEach(it => listEl.appendChild(renderPhoto(it))); }
async function fileToPreview(file, maxEdge=400){ return new Promise((resolve) => { const url = URL.createObjectURL(file); const img = new Image(); img.onload = () => { const w = img.width, h = img.height; const scale = Math.min(1, maxEdge/Math.max(w,h)); const nw = Math.round(w*scale), nh = Math.round(h*scale); const c = document.createElement('canvas'); c.width=nw; c.height=nh; const cx = c.getContext('2d'); cx.drawImage(img,0,0,nw,nh); const data = c.toDataURL('image/jpeg', 0.8); URL.revokeObjectURL(url); resolve(data); }; img.src = url; }); }
async function fileToResizedBlob(file, maxEdge=1600){ return new Promise((resolve) => { const url = URL.createObjectURL(file); const img = new Image(); img.onload = () => { const w = img.width, h = img.height; const scale = Math.min(1, maxEdge/Math.max(w,h)); const nw = Math.round(w*scale), nh = Math.round(h*scale); const c = document.createElement('canvas'); c.width=nw; c.height=nh; const cx = c.getContext('2d'); cx.drawImage(img,0,0,nw,nh); c.toBlob(b => { URL.revokeObjectURL(url); resolve(b); }, 'image/jpeg', 0.85); }; img.src = url; }); }
// Sensors
document.getElementById('getGPS').addEventListener('click', requestOneShotGPS);
document.getElementById('getHeading').addEventListener('click', async () => {
  const status = $("#status");
  const handle = (headingDeg) => { deviceHeading = ((headingDeg%360)+360)%360; status.textContent = `Heading: ${deviceHeading.toFixed(0)}¬∞`; batch.forEach(it => { if(it.heading==null) it.heading = deviceHeading; recomputeSubject(it); }); refreshList(); };
  if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    try { const p = await DeviceOrientationEvent.requestPermission(); if (p !== 'granted') { status.textContent = "Heading: permission denied (set manually)."; return; } } catch(e){ status.textContent = "Heading: permission error."; return; }
  }
  window.addEventListener('deviceorientation', function onOrient(e){ let heading = null; if(e.webkitCompassHeading != null) heading = e.webkitCompassHeading; else if(e.alpha != null) heading = 360 - e.alpha; if(heading != null){ handle(heading); window.removeEventListener('deviceorientation', onOrient); } }, { once:true });
});
async function startGPSWatch(){
  const status = $("#status"); const httpsHint = $("#httpsHint");
  httpsHint.textContent = location.protocol === 'https:' || location.hostname === 'localhost' || location.protocol === 'file:' ? "" : "Not HTTPS/localhost ‚Äî browser GPS will not prompt. Use HTTPS or open as a File URL.";
  if(!navigator.geolocation){ status.textContent = "GPS not supported in this browser."; return; }
  if (navigator.permissions?.query) { try{ const p = await navigator.permissions.query({ name:'geolocation' }); permissionState = p.state; p.onchange = ()=> permissionState = p.state; if (p.state === 'denied') { status.textContent = "GPS: denied ‚Äî Site settings ‚Üí Location ‚Üí Allow, then reload."; return; } }catch(e){} }
  navigator.geolocation.watchPosition(pos => { const { latitude, longitude, accuracy } = pos.coords; deviceGPS = { lat: latitude, lon: longitude, acc: accuracy, src:'device' }; status.textContent = `GPS: ${latitude.toFixed(6)}, ${longitude.toFixed(6)} (¬±${Math.round(accuracy)} m)`; let changed = false; batch.forEach(it => { if(!it.camera_gps && document.getElementById('gpsMode').value !== 'exif_only'){ it.camera_gps = { ...deviceGPS }; recomputeSubject(it); changed = true; } }); if(changed) refreshList(); }, err => { status.textContent = `GPS error: ${err.message}`; }, { enableHighAccuracy:true, maximumAge:0, timeout:10000 });
}
function requestOneShotGPS(){
  const status = $("#status");
  if(!navigator.geolocation){ status.textContent = "GPS not supported."; return; }
  if(permissionState === 'denied'){ status.textContent = "GPS: denied ‚Äî enable in Site settings first."; return; }
  status.textContent = "Requesting GPS‚Ä¶";
  navigator.geolocation.getCurrentPosition((pos)=>{ const { latitude, longitude, accuracy } = pos.coords; deviceGPS = { lat: latitude, lon: longitude, acc: accuracy, src:'device' }; status.textContent = `GPS: ${latitude.toFixed(6)}, ${longitude.toFixed(6)} (¬±${Math.round(accuracy)} m)`; let changed = false; batch.forEach(it => { if(!it.camera_gps && document.getElementById('gpsMode').value !== 'exif_only'){ it.camera_gps = {...deviceGPS}; recomputeSubject(it); changed = true; } }); if(changed) refreshList(); }, (err)=>{ status.textContent = "GPS error: " + err.message; }, { enableHighAccuracy:true, maximumAge:10000, timeout:12000 });
}
// Intake
$("#fileInput").addEventListener('change', async (e) => { const files = Array.from(e.target.files || []); for(const f of files){ await pushFileWithAutoTags(f); } refreshList(); });
async function pushFileWithAutoTags(f, extraTags=[]){
  const id = uid(); const mode = document.getElementById('gpsMode').value;
  const useExif = (mode === 'prefer_exif' || mode === 'exif_only'); const useDevice = (mode === 'prefer_exif' || mode === 'device_only');
  const exif = useExif ? await readEXIFGPS(f) : null; const preview = await fileToPreview(f);
  let camGPS = null; if(exif) camGPS = exif; else if(useDevice && deviceGPS) camGPS = {...deviceGPS};
  const item = { id, file: f, name: f.name, ts: Date.now(), preview, camera_gps: camGPS, subject_gps: null, heading: deviceHeading ?? null, dist_m: null, tags: extraTags.slice(), notes:'', snap_hint:'none', conditions: [], voice:null };
  if(item.camera_gps && item.camera_gps.src === 'exif' && deviceGPS && deviceGPS.acc!=null){ item.camera_gps.acc = deviceGPS.acc; }
  recomputeSubject(item); batch.push(item);
}
function recomputeSubject(it){
  const cam = it.camera_gps; const dist = isFinite(it.dist_m) ? it.dist_m : parseFloat($("#defaultDist").value || '0') || 0;
  let heading = it.heading; if (heading==null || isNaN(heading)) { const def = parseFloat($("#defaultHeading").value); if (isFinite(def)) heading = def; }
  if(cam && isFinite(dist) && isFinite(heading)){ it.subject_gps = offsetLatLon(cam.lat, cam.lon, dist, heading); } else { it.subject_gps = null; }
}
// Batch voice
const recBatchBtn = $("#recBatch"), stopBatchBtn = $("#stopBatch"), batchAudioEl = $("#batchAudio");
async function startRecorderBatch(){ if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) throw new Error("Media not supported"); if(!mediaStream) mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true }); return new MediaRecorder(mediaStream); }
recBatchBtn.addEventListener('click', async () => { try{ recBatchBtn.disabled = true; stopBatchBtn.disabled = false; recorder = await startRecorderBatch(); chunks = []; const start = Date.now(); recorder.ondataavailable = (e)=>{ if(e.data && e.data.size>0) chunks.push(e.data); }; recorder.onstop = ()=>{ batchAudioBlob = new Blob(chunks, { type: chunks[0]?.type || 'audio/webm' }); batchAudioExt = (batchAudioBlob.type.includes('ogg') ? 'ogg' : 'webm'); const url = URL.createObjectURL(batchAudioBlob); batchAudioEl.src = url; batchAudioEl.classList.remove('hidden'); batchAudioEl.dataset.duration = ((Date.now()-start)/1000).toFixed(1); }; recorder.start(); }catch(e){ alert('Mic not available or permission denied.'); recBatchBtn.disabled = false; stopBatchBtn.disabled = true; } });
stopBatchBtn.addEventListener('click', () => { try{ if(recorder && recorder.state!=='inactive') recorder.stop(); }catch(e){} recBatchBtn.disabled = false; stopBatchBtn.disabled = true; });
// Solar math
function solarPos(date, lat, lon){
  const d2r = Math.PI/180, r2d = 180/Math.PI;
  const t = (date - new Date(Date.UTC(date.getUTCFullYear(),0,1,0,0,0,0))) / 86400000 + 1;
  const gamma = 2*Math.PI/365*(t-1 + ((date.getUTCHours()-12)/24));
  const decl = 0.006918 - 0.399912*Math.cos(gamma) + 0.070257*Math.sin(gamma) - 0.006758*Math.cos(2*gamma) + 0.000907*Math.sin(2*gamma) - 0.002697*Math.cos(3*gamma) + 0.00148*Math.sin(3*gamma);
  const eqt = 229.18*(0.000075 + 0.001868*Math.cos(gamma) - 0.032077*Math.sin(gamma) - 0.014615*Math.cos(2*gamma) - 0.040849*Math.sin(2*gamma));
  const offset = date.getTimezoneOffset(); const tst = date.getUTCHours()*60 + date.getUTCMinutes() + eqt + 4*lon + offset;
  const ha = (tst/4 - 180) * d2r; const latr = 46.0201*d2r;
  const elev = Math.asin(Math.sin(latr)*Math.sin(decl) + Math.cos(latr)*Math.cos(decl)*Math.cos(ha));
  const az = Math.atan2(-Math.sin(ha), Math.tan(decl)*Math.cos(latr) - Math.sin(latr)*Math.cos(ha));
  return { elev: elev*r2d, az: (az*r2d+360)%360 };
}
function incidenceAngle(elevDeg, sunAzDeg, tiltDeg, panelAzDeg){
  const el = toRad(elevDeg), sa = toRad(sunAzDeg), ti=toRad(tiltDeg), pa=toRad(panelAzDeg);
  const cosT = Math.sin(el)*Math.cos(ti) + Math.cos(el)*Math.sin(ti)*Math.cos(sa - pa);
  return Math.max(0, Math.min(1, cosT));
}
function tempDerate(tairC){ const cell = tairC + 20; return 1 - 0.004*Math.max(0, cell - 25); }
function cloudFactor(cloudFrac){ return 1 - 0.75*Math.pow(cloudFrac, 3); }
document.getElementById('estimatePV').addEventListener('click', () => {
  const pvW = parseFloat($('#pvW').value||'700'); const tilt = parseFloat($('#tilt').value||'25'); const azm = parseFloat($('#azm').value||'180');
  const shade = (parseFloat($('#shade').value||'0')/100); const cloud = (parseFloat($('#cloud').value||'0')/100); const tair = parseFloat($('#tair').value||'20');
  const now = new Date(); const sun = solarPos(now);
  const poa = incidenceAngle(sun.elev, sun.az, tilt, azm); const derate = tempDerate(tair) * (1 - shade) * cloudFactor(cloud); const pred = Math.max(0, pvW * poa * derate);
  $('#pvStatus').textContent = `Sun elev ${sun.elev.toFixed(1)}¬∞, az ${sun.az.toFixed(0)}¬∞. POA=${poa.toFixed(2)}, derate=${derate.toFixed(2)} ‚Üí Pred ${pred.toFixed(0)} W`;
});
document.getElementById('recordPV').addEventListener('click', () => {
  const pvW = parseFloat($('#pvW').value||'700'); const tilt = parseFloat($('#tilt').value||'25'); const azm = parseFloat($('#azm').value||'180');
  const shade = (parseFloat($('#shade').value||'0')/100); const cloud = (parseFloat($('#cloud').value||'0')/100); const tair = parseFloat($('#tair').value||'20');
  const oupesW = parseFloat($('#oupesW').value||'NaN'); const now = new Date(); const sun = solarPos(now); const poa = incidenceAngle(sun.elev, sun.az, tilt, azm); const derate = tempDerate(tair) * (1 - shade) * cloudFactor(cloud); const pred = Math.max(0, pvW * poa * derate);
  const rec = { t_iso: now.toISOString(), pvW, tilt, azm, shade_pct: shade*100, cloud_pct: cloud*100, tair_C: tair, sun: { elev_deg: sun.elev, az_deg: sun.az }, poa, derate, pred_W: pred, oupes_W: isFinite(oupesW)? oupesW : null };
  const arr = loadSolar(); arr.push(rec); saveSolar(arr); $('#pvStatus').textContent = `Saved: pred ${pred.toFixed(0)} W` + (isFinite(oupesW)? `, measured ${oupesW.toFixed(0)} W` : '');
});
document.getElementById('exportPV').addEventListener('click', () => { const arr = loadSolar(); const blob = new Blob([JSON.stringify({ module: "EH1003006 Solar Dataset", version: "1.0", parcel: "EH1003006", samples: arr }, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = "eh1003006_solar_dataset_v1_0.json"; a.click(); URL.revokeObjectURL(url); });
document.getElementById('clearPV').addEventListener('click', () => { localStorage.removeItem(SOLAR_KEY); $('#pvStatus').textContent = "Solar dataset cleared."; });
// Manifest & export
function rolesFromQuick(){ return Array.from(document.querySelectorAll('#quickTags .tag.on')).map(x=>x.textContent.trim()); }
document.querySelectorAll('#quickTags .tag').forEach(el => el.addEventListener('click', ()=> el.classList.toggle('on')));
function collectManifest(embedImages=false){
  const checks = []; const chk = ['erosion_present','standing_water','invasives_dense','wildlife_sign','access_blocked']; // (kept simple)
  const mf = { module: "EH1003006 Field Intake", version: "1.3.3", parcel: "EH1003006", default_location: { lat: 46.0201, lon: -122.5488 },
    defaults: { subject_distance_m: parseFloat($("#defaultDist").value || '0') || 0, heading_deg: (h => isFinite(h) ? h : null)(parseFloat($("#defaultHeading").value)) },
    assets: Array.from($('#assets').selectedOptions).map(o=>o.value), title: $("#batchTitle").value || null, tags: rolesFromQuick(), batch_conditions: checks,
    notes: $("#batchNotes").value || null, batch_voice: batchAudioBlob ? { filename: "batch_voice.webm", duration_s: Number(document.getElementById('batchAudio').dataset.duration||0) } : null,
    created_utc: new Date().toISOString(),
    solar_model: (function(){ const pvW = parseFloat($('#pvW').value||'700'); const tilt = parseFloat($('#tilt').value||'25'); const azm = parseFloat($('#azm').value||'180'); const shade = (parseFloat($('#shade').value||'0')/100); const cloud = (parseFloat($('#cloud').value||'0')/100); const tair = parseFloat($('#tair').value||'20'); return { pvW, tilt, azm, shade_pct: shade*100, cloud_pct: cloud*100, tair_C: tair }; })(),
    solar_session: window._solarSession || null,
    items: batch.map(it => ({ id: it.id, filename: it.name, timestamp_utc: new Date(it.ts).toISOString(), camera_gps: it.camera_gps || null, subject_gps: it.subject_gps || null, heading_deg: (it.heading!=null?it.heading:null), subject_distance_m: (isFinite(it.dist_m)?it.dist_m:null), tags: it.tags, roles: rolesFromTags(it.tags), snap_hint: it.snap_hint || 'none', conditions: it.conditions, notes: it.notes || null, voice: it.voice ? { filename: `voice_${it.id}.${it.voice.ext}`, duration_s: Math.round(it.voice.duration||0) } : null, image_data_url: embedImages ? it.preview : undefined })) };
  return mf;
}
$("#copyForChat").addEventListener('click', async () => { const m = collectManifest(true); const text = "EH1003006 Photo Batch Manifest (v1.3.3)\n" + JSON.stringify(m, null, 2); try{ await navigator.clipboard.writeText(text); $("#buildInfo").textContent = "Copied manifest (with previews) to clipboard."; } catch(e){ $("#buildInfo").textContent = "Clipboard blocked. Use Download manifest.json."; } });
$("#downloadManifest").addEventListener('click', () => { const m = collectManifest(true); const blob = new Blob([JSON.stringify(m, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = "eh1003006_photo_manifest_v1_3_3.json"; a.click(); URL.revokeObjectURL(url); });
$("#buildTest").addEventListener('click', () => { const m = collectManifest(false); m.items.forEach(it => { delete it.image_data_url; }); const blob = new Blob([JSON.stringify(m, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = "eh1003006_test_manifest_v1_3_3.json"; a.click(); URL.revokeObjectURL(url); });
function summarizeForValidation(manifest){
  const items = manifest.items || []; const gpsOk = items.filter(it => it.camera_gps && isFinite(it.camera_gps.lat) && isFinite(it.camera_gps.lon)).length; const withSubject = items.filter(it => it.subject_gps).length; const withVoice = items.filter(it => it.voice).length; const tags = {}; items.forEach(it=> (it.tags||[]).forEach(t=> tags[t]=(tags[t]||0)+1 )); const roles = {}; items.forEach(it=> (it.roles||[]).forEach(r=> roles[r]=(roles[r]||0)+1 )); const thumbs = items.slice(0,12).map(it => ({ id: it.id, name: it.filename, preview: it.image_data_url || it.preview || null, tags: it.tags||[], gps: it.camera_gps||null })); let samples = []; try { samples = JSON.parse(localStorage.getItem('EH1003006:solar_samples')||'[]'); } catch {} const n = samples.length; const last = n? samples[n-1] : null; return { module: "EH1003006 Validation Pack", version: "1.0", parcel: "EH1003006", created_utc: new Date().toISOString(), manifest_version: manifest.version, counts: { items: items.length, gps_ok: gpsOk, subject_ok: withSubject, voice: withVoice }, tag_hist: tags, role_hist: roles, solar_summary: { count:n, last }, sample_thumbs: thumbs }; }
$("#buildValidation").addEventListener('click', () => { const m = collectManifest(true); const v = summarizeForValidation(m); const blob = new Blob([JSON.stringify(v, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = "eh1003006_validation_pack_v1_3_3.json"; a.click(); URL.revokeObjectURL(url); });
let JSZipLoaded = False = false;
async function ensureJSZip(){ if(JSZipLoaded) return true; return new Promise((resolve)=>{ const s = document.createElement('script'); s.src = "https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"; s.onload = ()=>{ JSZipLoaded = true; resolve(true); }; s.onerror = ()=> resolve(false); document.body.appendChild(s); }); }
$("#buildZip").addEventListener('click', async () => { $("#buildInfo").textContent = "Preparing ZIP‚Ä¶"; const ok = await ensureJSZip(); if(!ok){ $("#buildInfo").textContent = "ZIP library failed (offline). Use manifest/test/validation."; return; } const zip = new JSZip(); const m = collectManifest(false); zip.file("manifest.json", JSON.stringify(m, null, 2)); const folder = zip.folder("images"); for(const it of batch){ const blob = await fileToResizedBlob(it.file, 1600); const arrbuf = await blob.arrayBuffer(); folder.file(it.name.replace(/\s+/g,'_').replace(/[^A-Za-z0-9._-]/g,''), arrbuf); } const afolder = zip.folder("audio"); if(batchAudioBlob){ const arr = await batchAudioBlob.arrayBuffer(); afolder.file(`batch_voice.${batchAudioExt}`, arr); } for(const it of batch){ if(it.voice && it.voice.blob){ const arr = await it.voice.blob.arrayBuffer(); afolder.file(`voice_${it.id}.${it.voice.ext}`, arr); } } const content = await zip.generateAsync({type:"blob"}); const url = URL.createObjectURL(content); const a = document.createElement('a'); a.href = url; a.download = "eh1003006_photo_batch_v1_3_3.zip"; a.click(); URL.revokeObjectURL(url); $("#buildInfo").textContent = "ZIP built."; });
// Persist to Planner
const KEY = "EH1003006:field_intake_records"; function loadLocal(){ try { return JSON.parse(localStorage.getItem(KEY) || "[]"); } catch { return []; } } function saveLocal(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
function persistToLocal(records){ const arr = loadLocal(); records.forEach(it => { arr.push({ tool_version: "v1_3_3", parcel: "EH1003006", lat: it.camera_gps?.lat ?? null, lng: it.camera_gps?.lon ?? null, accuracy_m: it.camera_gps?.acc ?? null, timestamp_ms: it.ts, category: (it.tags.includes('geese') ? 'geese' : it.tags.includes('chickens') ? 'chickens' : it.tags.includes('solar-panel') ? 'solar' : it.tags[0] || 'intake'), notes: it.notes || "", photo_data_url: it.preview }); }); saveLocal(arr); }
const observer = new MutationObserver(()=>{ const withGPS = batch.filter(it => it.camera_gps && isFinite(it.camera_gps.lat) && isFinite(it.camera_gps.lon)); if(withGPS.length) persistToLocal(withGPS); });
observer.observe(document.getElementById('list'), { childList:true, subtree:true });
window.addEventListener('load', startGPSWatch);
// ---- Solar 360 Capture toggle behaviour ----
const solarToggle = document.getElementById('solarToggle'); const solarGuide = document.getElementById('solarGuide'); const solarState = document.getElementById('solarState'); const prog = document.getElementById('solarProgress');
window._solarSession = { enabled:false, steps:{1:false,2:false,3:false,4:false}, started_utc:null, finished_utc:null };
function updateSolarUI(){ solarState.textContent = solarToggle.classList.contains('on') ? 'on' : 'off'; prog.textContent = `Progress: ${Object.values(window._solarSession.steps).filter(Boolean).length}/4`; }
solarToggle.addEventListener('click', ()=>{ const on = solarToggle.classList.toggle('on'); const enabled = on; solarGuide.classList.toggle('hidden', !on); window._solarSession.enabled = enabled; if(enabled && !window._solarSession.started_utc) window._solarSession.started_utc = new Date().toISOString(); updateSolarUI(); });
solarToggle.addEventListener('keydown', (e)=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); solarToggle.click(); }});
document.querySelectorAll('[data-stepdone]').forEach(btn => { btn.addEventListener('click', ()=>{ const k = Number(btn.getAttribute('data-stepdone')); window._solarSession.steps[k] = true; updateSolarUI(); if(Object.values(window._solarSession.steps).every(Boolean)) window._solarSession.finished_utc = new Date().toISOString(); }); });
async function hookStepInput(inpId, tags){ const inp = document.getElementById(inpId); inp.addEventListener('change', async (e)=>{ const files = Array.from(e.target.files||[]); for(const f of files){ await pushFileWithAutoTags(f, tags); } refreshList(); }); }
hookStepInput('step1Add', ['site-context','solar-panel']); hookStepInput('step2Add', ['solar-panel']); hookStepInput('step3Add', ['site-context','solar-panel']); hookStepInput('step4Add', ['site-context','solar-panel','weather']);
document.getElementById('solarSummarize').addEventListener('click', ()=>{ const s = window._solarSession; const done = Object.values(s.steps).filter(Boolean).length; const note = `Solar 360 session ‚Äî steps complete: ${done}/4; start ${s.started_utc||'‚Äî'}; finish ${s.finished_utc||'‚Äî'}.`; const el = document.getElementById('batchNotes'); el.value = (el.value ? el.value + '\\n' : '') + note; });
</script>
</body>
</html>
