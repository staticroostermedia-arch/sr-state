<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EH1003006 Online Planner — v5.2.9 (with Intake Bridge)</title>

  <!-- Core map libs -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.2/dist/leaflet-geoman.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.2/dist/leaflet-geoman.min.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://unpkg.com/chart.js@4.4.3/dist/chart.umd.js"></script>

  <!-- Local GeoTIFF raster rendering + analysis -->
  <script src="https://unpkg.com/geotiff/dist-browser/geotiff.js"></script>
  <script src="https://unpkg.com/georaster/dist/georaster.browser.min.js"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet/dist/georaster-layer-for-leaflet.min.js"></script>
  <script src="https://unpkg.com/proj4@2.11.0/dist/proj4.js"></script>
  <script src="https://unpkg.com/geoblaze@1.3.4/dist/geoblaze.umd.js"></script>

  <style>
    :root { --bg: #0b1020; --panel: #0f172a; --card: #0c1930; --ink: #e2e8f0; --muted: #94a3b8;
      --accent: #60a5fa; --accent-2: #22c55e; --warn: #f97316; --danger: #ef4444; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--ink); font-family: system-ui, ui-sans-serif, Segoe UI, Roboto, Helvetica, Arial; }
    #app { display:grid; grid-template-rows: auto auto 1fr auto; gap:10px; height:100%; }
    #toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; padding:10px 12px; background:var(--panel); border-bottom:1px solid #1f2937; }
    #map { height: 56vh; }
    #panel { display:grid; grid-template-columns: repeat(12, 1fr); gap:10px; padding:10px 12px; background:var(--panel); }
    #footer { padding:8px 12px; font-size:12px; color:var(--muted); background:#0a0f1f; border-top:1px solid #1f2937; }
    .badge { font-size:12px; background:rgba(96,165,250,0.15); color:#93c5fd; padding:2px 8px; border-radius:999px; border:1px solid rgba(96,165,250,0.35); }
    .btn { padding:8px 12px; border-radius:10px; background:#1f6feb; color:white; cursor:pointer; border:none; font-weight:600; }
    .btn.secondary { background:#334155; }
    .btn.ghost { background:transparent; border:1px solid #334155; color:#e5e7eb; }
    .btn.warn { background:#b91c1c; }
    .btn.good { background:#16a34a; }
    .pill { background:#0b1326; padding:4px 8px; border:1px solid #1e293b; border-radius:999px; min-width:64px; text-align:center; color:#e2e8f0; }
    .kbd { font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px; background:#0b1326; border:1px solid #1e293b; padding:0 6px; border-radius:6px; color:#cbd5e1; }
    .card { background:var(--card); border:1px solid #0b1225; border-radius:12px; padding:10px; }
    .card h3 { margin:0 0 8px 0; font-size:14px; color:#cbd5e1; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .small { font-size:12px; color:var(--muted); }
    .divider { height:1px; background:#1e293b; margin:8px 0; }
    .layer-row { display:flex; align-items:center; gap:8px; margin-bottom:4px; }
    .layer-row input[type=range] { width:120px; }
    .badge.good { background:rgba(34,197,94,0.12); color:#86efac; border-color:rgba(34,197,94,0.35); }
    .thumb { width: 160px; height:auto; border-radius:8px; border:1px solid #1e293b; display:block; margin-top:6px; }
  </style>
</head>
<body>
<div id="app">
  <div id="toolbar">
    <span class="badge">EH1003006 • 46.0201, -122.5488 (Cowlitz, WA)</span>
    <span class="badge">Starlink • Wi‑Fi + cams • Solar present</span>
    <span class="badge">Invasives: Himalayan blackberry</span>
    <span class="badge">Online Planner v5.2.9</span>
    <span id="lidarBadge" class="badge">LiDAR: loading…</span>
  </div>

  <div id="map"></div>
  <div class="version-badge" style="position:absolute;top:10px;left:10px;z-index:1000;background:rgba(0,0,0,0.6);color:#fff;padding:6px 10px;border-radius:8px;font-size:12px;">
    <strong>EH1003006 Online Planner</strong> — v5.2.9
  </div>

  <div id="panel">
    <div class="card" style="grid-column:span 4;">
      <h3>Hydro Profile & Power</h3>
      <div class="row">
        <div>Active line: <span id="activeName" class="pill">–</span></div>
        <button id="recalc" class="btn">Recompute</button>
        <button id="clear" class="btn secondary">Clear</button>
      </div>
      <div class="row">
        <div>Length: <span id="len" class="pill">–</span></div>
        <div>Start: <span id="z0" class="pill">–</span></div>
        <div>End: <span id="z1" class="pill">–</span></div>
        <div>Head: <span id="drop" class="pill">–</span></div>
        <div>Slope: <span id="slope" class="pill">–</span></div>
      </div>
      <div class="row">
        <div>Gain: <span id="gain" class="pill">–</span></div>
        <div>Loss: <span id="loss" class="pill">–</span></div>
      </div>
      <div class="row" style="margin-top:6px;">
        <label>Flow (cfs) <input id="flowCFS" class="input" type="number" value="0.50" step="0.01" min="0" style="width:90px;"/></label>
        <label>η (0–1) <input id="eta" class="input" type="number" value="0.70" step="0.01" min="0" max="1" style="width:90px;"/></label>
      </div>
      <div class="row" style="margin-top:6px;">
        <span id="powerW" class="pill">– W</span>
        <span id="powerkW" class="pill">– kW</span>
        <span id="hp" class="pill">– hp</span>
      </div>
      <div class="divider"></div>
      <div class="row">
        <label class="switch"><input type="checkbox" id="useLocalLidar" checked /> <span>Use local LiDAR for elevation (fallback: USGS)</span></label>
      </div>
    </div>

    <div class="card" style="grid-column:span 4;">
      <h3>Online Layers</h3>
      <div id="layerList" class="small"></div>
      <div class="divider"></div>
      <h3>Field Intake (Local)</h3>
      <div class="row">
        <button id="importIntake" class="btn good">Import Saved Intakes</button>
        <button id="clearIntake" class="btn warn">Clear Saved Intakes</button>
      </div>
      <div id="intakeSummary" class="small" style="margin-top:6px;"></div>
    </div>

    <div class="card" style="grid-column:span 4;">
      <h3>Site Planner & Vegetation</h3>
      <div class="row">
        <label class="btn ghost" for="geojsonFile">Upload GeoJSON</label>
        <input id="geojsonFile" type="file" accept=".geojson,application/geo+json,application/json" style="display:none;" />
        <button id="exportNotes" class="btn secondary">Export notes (.geojson)</button>
        <label class="btn ghost" for="importNotes">Import notes</label>
        <input id="importNotes" type="file" accept=".geojson,application/json" style="display:none;" />
      </div>
      <div class="divider"></div>
      <button id="analyzeBtn" class="btn good">Analyze Selected Features</button>
      <div id="report" class="small" style="margin-top:8px; max-height:180px; overflow:auto;"></div>
    </div>

    <div class="card" style="grid-column:span 12;">
      <canvas id="profile" style="height:28vh"></canvas>
    </div>
  </div>

  <div id="footer">
    <div>Draw penstock with the pencil, click intake (high) → powerhouse (low). Export/Import notes includes <strong>v5.2.9</strong> in filenames. Use “Import Saved Intakes” to ingest field points saved by the Field Intake tool (localStorage).</div>
  </div>
</div>

<script>
const center = [46.0201, -122.5488];
const map = L.map('map', { center, zoom: 17 });
const layerList = document.getElementById('layerList');
function addLayerRow(name, layer){
  const row = document.createElement('div'); row.className = 'layer-row';
  const chk = document.createElement('input'); chk.type='checkbox'; try{ chk.checked = false; }catch(_){}
  const label = document.createElement('label'); label.textContent = name;
  const slider = document.createElement('input'); slider.type='range'; slider.min=0; slider.max=1; slider.step=0.05; slider.value=layer.options.opacity ?? 1;
  chk.addEventListener('change', () => { if(chk.checked) layer.addTo(map); else layer.remove(); });
  slider.addEventListener('input', () => layer.setOpacity(parseFloat(slider.value)));
  row.appendChild(chk); row.appendChild(label); row.appendChild(slider);
  layerList.appendChild(row);
}

const parcelGeoJSON = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{},"geometry":{"type":"Polygon","coordinates":[[[-122.55044,46.020375],[-122.550483,46.018312],[-122.547865,46.018312],[-122.547865,46.018848],[-122.545161,46.018848],[-122.545129,46.020383],[-122.55044,46.020375]]]}}]};
const parcelLayer = L.geoJSON(parcelGeoJSON, { style: { color:'#ef4444', weight:3, fillOpacity:0.06 } });
const parcelCenter = [46.0201, -122.5488];
const parcelNotes = L.marker(parcelCenter).bindPopup(`
  <b>Parcel:</b> EH1003006<br/>
  <b>County:</b> Cowlitz, WA<br/>
  <b>Coords:</b> 46.020100, -122.548800<br/>
  <hr style="margin:6px 0" />
  <div style="font-size:12px;line-height:1.2">Starlink internet • Wi‑Fi + cams • Solar present<br/>Issue: invasive blackberries</div>
`);
const parcelGroup = L.layerGroup([ parcelLayer, parcelNotes ]).addTo(map);
try { map.fitBounds(parcelLayer.getBounds()); } catch(e){}

map.pm.addControls({ position:'topleft', drawMarker:true, drawPolyline:true, drawRectangle:true, drawCircle:true, drawPolygon:true, editMode:true, dragMode:true, cutPolygon:true, removalMode:true });
const drawn = L.featureGroup().addTo(map);
const vegGroup = L.featureGroup().addTo(map);
const endpoints = L.layerGroup().addTo(map);

// Basemaps
const usgsTopo = L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'USGS' }).addTo(map);
const usgsImageryTopo = L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryTopo/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'USGS' });
L.control.layers({ 'USGS Topo': usgsTopo, 'USGS ImageryTopo': usgsImageryTopo }, null, { position:'topright' }).addTo(map);

// Online overlays
const overlays = {
  'Parcel & Notes': parcelGroup,
  "WA DNR LiDAR Hillshade": L.esri.dynamicMapLayer({ url: 'https://gis.dnr.wa.gov/site1/rest/services/Public_Geology/Lidar_Hillshade/MapServer', opacity: 0.6 }),
  "USGS NHD (Hydrography)": L.esri.dynamicMapLayer({ url: 'https://hydro.nationalmap.gov/arcgis/rest/services/nhd/MapServer', opacity: 0.8 }),
  "USFWS NWI Wetlands": L.esri.dynamicMapLayer({ url: 'https://fwspublicservices.wim.usgs.gov/wetlandsmapservice/rest/services/Wetlands/MapServer', opacity: 0.75 })
};
Object.entries(overlays).forEach(([name, layer]) => addLayerRow(name, layer));

// Local rasters (DTM + optional slope/aspect/CHM)
async function fetchArrayBufferFrom(urls){
  for(const u of urls){
    try { const res = await fetch(u); if(res.ok){ const buf = await res.arrayBuffer(); return { url: u, buf }; } } catch(e){}
  } throw new Error('No URL available');
}
function rampGreen(v, vmin, vmax){
  v = Array.isArray(v)?v[0]:v; if(v==null||isNaN(v)) return null;
  const t = Math.max(0, Math.min(1, (v - vmin)/(vmax - vmin)));
  const g = Math.floor(40 + 180*t); const r = Math.floor(20 + 50*t); const b = Math.floor(20 + 40*(1-t));
  return `rgba(${r},${g},${b},1)`;
}
function rampSlope(v){
  v = Array.isArray(v)?v[0]:v; if(v==null||isNaN(v)) return null;
  if(v < 10) return 'rgba(34,197,94,0.85)'; if(v < 30) return 'rgba(245,158,11,0.85)'; return 'rgba(239,68,68,0.9)';
}
function colorAspect(v){
  v = Array.isArray(v)?v[0]:v; if(v==null||isNaN(v)) return null;
  const d = ((v%360)+360)%360;
  if(d<45) return 'rgba(59,130,246,0.7)'; if(d<90) return 'rgba(45,212,191,0.7)'; if(d<135) return 'rgba(16,185,129,0.7)';
  if(d<180) return 'rgba(132,204,22,0.7)'; if(d<225) return 'rgba(234,179,8,0.7)'; if(d<270) return 'rgba(249,115,22,0.7)';
  if(d<315) return 'rgba(168,85,247,0.7)'; return 'rgba(99,102,241,0.7)';
}
let localDTM=null; let dtmLayer=null;
(async function loadRasters(){
  const badge = document.getElementById('lidarBadge');
  try {
    const { buf } = await fetchArrayBufferFrom(['../data/eh1003006_dtm_clip.tif','eh1003006_dtm_clip.tif']);
    localDTM = await parseGeoraster(buf);
    const MIN_FT=1106, MAX_FT=1476;
    dtmLayer = new GeoRasterLayer({
      georaster: localDTM, opacity: 0.85, resolution: 96,
      pixelValuesToColorFn: ([v]) => {
        if(v==null||isNaN(v)) return null;
        const t = Math.max(0, Math.min(1, (v - MIN_FT) / (MAX_FT - MIN_FT)));
        const g = Math.floor(255*t); return `rgba(${g},${g},${g},1)`;
      }
    }).addTo(map);
    addLayerRow('EH1003006 LiDAR DTM (local)', dtmLayer);
    try { map.fitBounds(dtmLayer.getBounds()); } catch(e){}
    badge.textContent='LiDAR DTM: loaded'; badge.classList.add('good');
  } catch (err) { console.error(err); badge.textContent='LiDAR DTM: failed'; }
  try {
    const { buf } = await fetchArrayBufferFrom(['eh1003006_slope_pct.tif','../data/eh1003006_slope_pct.tif']);
    const slopeRaster = await parseGeoraster(buf);
    const slopeLayer = new GeoRasterLayer({ georaster: slopeRaster, opacity:0.55, resolution:96, pixelValuesToColorFn: ([v])=>rampSlope(v) });
    addLayerRow('Slope % (local)', slopeLayer);
  } catch(e){}
  try {
    const { buf } = await fetchArrayBufferFrom(['eh1003006_aspect_deg.tif','../data/eh1003006_aspect_deg.tif']);
    const aspectRaster = await parseGeoraster(buf);
    const aspectLayer = new GeoRasterLayer({ georaster: aspectRaster, opacity:0.5, resolution:96, pixelValuesToColorFn: ([v])=>colorAspect(v) });
    addLayerRow('Aspect ° (local)', aspectLayer);
  } catch(e){}
  try {
    const { buf } = await fetchArrayBufferFrom(['eh1003006_chm.tif','../data/eh1003006_chm.tif']);
    const chmRaster = await parseGeoraster(buf);
    const chmLayer = new GeoRasterLayer({ georaster: chmRaster, opacity:0.6, resolution:96, pixelValuesToColorFn: ([v])=>rampGreen(v,0,40) });
    addLayerRow('Canopy Height (local)', chmLayer);
  } catch(e){}
})();

// --- Drawing & analysis (trimmed for brevity) ---
let lineSeq=0, active=null;
function setActive(l){ active=l; document.getElementById('activeName').innerText = l? (l._lineName||'Line') : '–'; }
function labelDistance(layer){
  try {
    const coords = (layer.getLatLngs().flat?layer.getLatLngs().flat():layer.getLatLngs()).map(ll=>[ll.lng,ll.lat]);
    const line = turf.lineString(coords); const meters = turf.length(line,{units:'kilometers'})*1000.0;
    return (meters*3.28084).toFixed(0)+' ft';
  } catch(e){ return ''; }
}
map.on('pm:create', e => {
  const l = e.layer;
  if(l instanceof L.Polyline && !(l instanceof L.Polygon)){
    l._lineName = 'Line ' + (++lineSeq);
    l.bindTooltip(labelDistance(l), {permanent:true}).openTooltip();
    l.on('click', ()=> setActive(l));
  }
});

// --- Profile chart + EPQS fallback ---
const ctx = document.getElementById('profile');
let chart = new Chart(ctx, { type:'line', data:{labels:[],datasets:[{label:'Elevation (ft)', data:[], fill:false, tension:0.15}]},
  options:{responsive:true,maintainAspectRatio:false,scales:{x:{title:{display:true,text:'Distance (ft)'}},y:{title:{display:true,text:'Elevation (ft)'}}}}});

async function epqsFeet(lon, lat){
  const url = `https://epqs.nationalmap.gov/v1/json?x=${lon}&y=${lat}&units=Feet&wkid=4326`;
  const res = await fetch(url); if(!res.ok) throw new Error('EPQS error'); const js = await res.json();
  return js?.value ?? js?.elevation ?? null;
}

// --- Intake Bridge ---
const KEY = "EH1003006:field_intake_records";
const intakeGroup = L.layerGroup().addTo(map);
const intakeSummary = document.getElementById('intakeSummary');

function loadIntake(){ try { return JSON.parse(localStorage.getItem(KEY) || "[]"); } catch { return []; } }
function clearIntake(){ localStorage.removeItem(KEY); }

function addIntakeToMap(rec){
  const m = L.marker([rec.lat, rec.lng]).addTo(intakeGroup);
  const img = rec.photo_data_url ? `<img class="thumb" src="${rec.photo_data_url}" alt="intake photo" />` : '';
  const when = new Date(rec.timestamp_ms||Date.now()).toLocaleString();
  const html = `<div class="small"><b>${rec.category||'intake'}</b> — ${when}<br/>
    ${rec.notes?('<div style="margin-top:4px">'+rec.notes+'</div>'):''}
    <div style="margin-top:6px;">${img}</div>
    <div style="margin-top:6px;">GPS: ${rec.lat.toFixed(6)}, ${rec.lng.toFixed(6)} (±${rec.accuracy_m||'?'} m)</div></div>`;
  m.bindPopup(html);
}

function importIntakes(){
  intakeGroup.clearLayers();
  const arr = loadIntake();
  arr.forEach(addIntakeToMap);
  intakeSummary.textContent = arr.length ? `${arr.length} intake record(s) loaded from device.` : 'No local intake records found.';
}

document.getElementById('importIntake').addEventListener('click', importIntakes);
document.getElementById('clearIntake').addEventListener('click', () => { clearIntake(); intakeGroup.clearLayers(); intakeSummary.textContent='Cleared local intake storage.'; });

</script>
</body>
</html>
