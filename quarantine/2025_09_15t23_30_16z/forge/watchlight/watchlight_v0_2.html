<!doctype html>
<meta charset="utf-8"/>
<title>Static Rooster — Watchlight v0.2</title>
<style>
  html,body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,sans-serif;background:#0b0f14;color:#dfe7ef;margin:0}
  .wrap{max-width:900px;margin:24px auto;padding:16px}
  .card{background:#121821;border:1px solid #223040;border-radius:12px;padding:16px;margin:12px 0}
  h1{font-size:20px;margin:0 0 8px}
  .k{color:#85b6ff}
  .v{color:#f2f8ff}
  code{background:#0e141b;border:1px solid #1d2a37;padding:2px 6px;border-radius:6px}
  .ok{color:#7dff7d}.warn{color:#ffd77d}.bad{color:#ff8a8a}
</style>
<div class="wrap">
  <h1>Static Rooster — Watchlight <small style="opacity:.6">v0.2</small></h1>
  <div id="now" class="card">Loading…</div>
  <div class="card">
    <b>Quick links</b> ·
    <a href="/receipts/" target="_blank">Receipts</a> ·
    <a href="/snapshots/" target="_blank">Snapshots</a> ·
    <a href="/forge/" target="_blank">Forge</a>
  </div>
</div>
<script>
(async () => {
  // Find newest sr_status_dump_*.json by scraping /receipts/ index (python http.server listing)
  async function newest(pattern) {
    const html = await fetch('/receipts/', {cache:'no-store'}).then(r=>r.text()).catch(()=> '');
    const m = [...html.matchAll(/href="(sr_status_dump_[^"]+\.json)"/g)].map(x=>x[1]).sort().reverse();
    if(!m.length) return null;
    return '/receipts/' + m[0];
  }
  function pill(code){
    if(code>=200 && code<300) return `<b class="ok">${code}</b>`;
    if(code>=300 && code<400) return `<b class="warn">${code}</b>`;
    return `<b class="bad">${code||'000'}</b>`;
  }
  const tgt = await newest();
  const box = document.getElementById('now');
  if(!tgt){ box.textContent = 'No status receipts yet. Trigger a pulse.'; return; }
  const j = await fetch(tgt, {cache:'no-store'}).then(r=>r.json()).catch(()=>null);
  if(!j){ box.textContent = 'Failed to load latest status receipt.'; return; }
  const http = j.http || {};
  const snap = j.snapshot_dir || '(none)';
  const verdict = j.verdict || 'unknown';
  box.innerHTML = `
    <div><span class="k">generated_at</span>: <span class="v">${j.generated_at||''}</span></div>
    <div><span class="k">verdict</span>: <code>${verdict}</code></div>
    <div><span class="k">snapshot</span>: <code>${snap}</code></div>
    <div style="margin-top:8px"><span class="k">http</span>:
      /forge=${pill(http["/forge"]||0)} ·
      /receipts=${pill(http["/receipts"]||0)} ·
      /decisionhub=${pill(http["/decisionhub"]||0)}
    </div>
    <div style="margin-top:8px;opacity:.7">host: ${j.host?.name||''} · ${j.host?.kernel||''} · ${j.host?.iface||''} · power=${j.host?.power||''}</div>
    <div style="margin-top:8px;opacity:.7"><small>file: ${tgt}</small></div>`;
})();
</script>
