<!doctype html>
<meta charset="utf-8">
<title>Static Rooster — Status Dashboard v0.1</title>
<style>
  body { font: 14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; background:#0b0d10; color:#e6edf3; }
  h1 { font-size: 20px; margin: 0 0 12px; }
  .grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); }
  .card { background:#11161b; border:1px solid #22303a; border-radius:12px; padding:14px; }
  .k { color:#9fb3c8; }
  .v.bad { color:#ff7b72; }
  .v.good { color:#3fb950; }
  code, pre { background:#0d1117; border:1px solid #22303a; border-radius:8px; padding:8px; display:block; overflow:auto; }
  a { color:#79c0ff; text-decoration:none; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  button { background:#1f6feb; color:white; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; }
  button:disabled { opacity:.6; cursor:default; }
  small { color:#9fb3c8; }
</style>

<h1>Static Rooster — Status Dashboard <small id="ts"></small></h1>

<div class="row" style="margin:12px 0 20px">
  <button id="refresh">Refresh</button>
  <small>Auto-refresh every <span id="freq">5</span>s.</small>
  <small>Open: <a href="/receipts/" target="_blank">/receipts/</a> • <a href="/snapshots/" target="_blank">/snapshots/</a> • <a href="/forge/watchlight/watchlight_v0_2.html" target="_blank">Watchlight</a></small>
</div>

<div class="grid">
  <div class="card">
    <b>Verdict</b>
    <div id="verdict">—</div>
    <small id="checkpoint_time"></small>
  </div>

  <div class="card">
    <b>Latest Snapshot</b>
    <div id="snapshot">—</div>
    <small id="manifest"></small>
  </div>

  <div class="card">
    <b>Canon Parity</b>
    <div id="parity">—</div>
    <small id="pin"></small>
  </div>

  <div class="card">
    <b>Env</b>
    <div id="env">—</div>
  </div>

  <div class="card">
    <b>Runner</b>
    <div id="runner">—</div>
  </div>

  <div class="card">
    <b>Recent Offenders</b>
    <pre id="offenders">[]</pre>
  </div>
</div>

<script>
const $ = (id) => document.getElementById(id);
const set = (id, html) => { $(id).innerHTML = html; };

async function fetchJSON(url) {
  const r = await fetch(url, {cache:'no-store'});
  if (!r.ok) throw new Error(url + ' -> ' + r.status);
  return await r.json();
}

function goodBad(str) {
  const s = String(str || '').toLowerCase();
  if (s.includes('foedus intactum') || s === 'ok' || s === 'green') return 'good';
  if (s.includes('penitential') || s.includes('drift') || s === 'bad' || s === 'unknown') return 'bad';
  return '';
}

async function refresh() {
  try {
    const status = await fetchJSON('/receipts/sr_status_dump_latest.json');
    const verdict = status.verdict || 'unknown';
    const cls = goodBad(verdict);
    set('verdict', `<span class="v ${cls}">${verdict}</span>`);
    set('checkpoint_time', status.checkpoint_time ? `checkpoint @ <span class="k">${status.checkpoint_time}</span>` : '');

    if (status.snapshot) {
      const snap = status.snapshot;
      const link = `/snapshots/${(snap.path || snap.dir || '')}`.replace(/\/+/g,'/');
      set('snapshot', snap.path ? `<a href="${link}" target="_blank">${snap.path}</a>` : JSON.stringify(snap));
      set('manifest', status.manifest ? `<code>${status.manifest}</code>` : '');
    } else set('snapshot','—');

    if (status.canon_parity) {
      const p = status.canon_parity.parity || status.canon_parity.status || 'unknown';
      set('parity', `<span class="v ${goodBad(p)}">${p}</span>`);
      set('pin', status.canon_parity.pin_sha256 ? `pin: <code>${status.canon_parity.pin_sha256.slice(0,12)}…</code>` : '');
    } else {
      set('parity','—'); set('pin','');
    }

    if (status.env) {
      const host = status.env.host || '—';
      const ker = status.env.kernel || '—';
      const iface = status.env.iface || '—';
      const power = status.env.power || '—';
      set('env', `<span class="k">host</span> ${host} · <span class="k">kernel</span> ${ker} · <span class="k">iface</span> ${iface} · <span class="k">power</span> ${power}`);
    } else set('env','—');

    if (status.offenders && status.offenders.items) {
      set('offenders', JSON.stringify(status.offenders.items.slice(0,20), null, 2));
    } else set('offenders','[]');

  } catch (e) {
    set('verdict', `<span class="v bad">status unavailable</span>`);
    set('checkpoint_time','');
    console.error(e);
  }

  // Try to show runner heartbeat if present (optional)
  try {
    const rl = await fetchJSON('/receipts/sr_runner_last.json');
    set('runner', `<code>${(rl.verdict || '—')} @ ${rl.generated_at || '—'}</code>`);
  } catch { set('runner','—'); }

  $('ts').textContent = new Date().toLocaleString();
}

document.getElementById('refresh').onclick = refresh;
refresh();
setInterval(refresh, 5000);
</script>
