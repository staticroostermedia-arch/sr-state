<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DecisionHub • Minimal Shell v0.1</title>
<style>
:root{--bg:#0b0c06;--grid:#1a2b1a;--text:#b4ffb4;--glow:#39ff14;--danger:#ff6b6b}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:ui-monospace,Consolas,monospace}
.bar{position:fixed;top:0;left:0;right:0;height:42px;display:flex;align-items:center;gap:8px;padding:8px 10px;background:#0f130f;border-bottom:1px solid var(--grid)}
.chip{border:1px solid var(--grid);border-radius:999px;padding:4px 10px}
.grow{flex:1}
.viewer{position:absolute;top:42px;left:0;right:0;bottom:120px;overflow:auto}
.composer{position:fixed;left:0;right:0;bottom:0;height:120px;border-top:1px solid var(--grid);background:#0f130f;padding:10px;display:grid;grid-template-columns:1fr auto;gap:10px}
textarea{width:100%;height:100%;resize:none;background:#0b0f0b;color:var(--text);border:1px solid var(--grid);border-radius:10px;padding:10px}
button{border:1px solid var(--grid);background:#101a10;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
.pill{font-size:12px;padding:4px 8px}
.ok{color:var(--glow)} .err{color:var(--danger)}
</style></head><body>
  <div class="bar">
    <span class="chip">Minimal Shell v0.1</span>
    <span class="chip" id="snapshot">snapshot: …</span>
    <span class="chip" id="ckpt">checkpoint: …</span>
    <div class="grow"></div>
    <button id="fullscreen" class="pill">Fullscreen</button>
    <button id="wake" class="pill">WakeLock</button>
  </div>
  <div class="viewer">
    <div style="padding:12px">
      <h2 style="margin:0 0 8px 0;color:var(--glow)">Kiosk Chat</h2>
      <p>Posts <code>message.json</code> + latest snapshot manifest (and optional tarball) to the local ingest.</p>
      <ul>
        <li>Reads <code>/receipts/snapshot_latest.json</code></li>
        <li>Reads <code>/receipts/sr_watch_checkpoint_v0_1.json</code></li>
        <li>POST → <code>http://localhost:8891/build</code></li>
      </ul>
    </div>
  </div>
  <div class="composer">
    <textarea id="msg" placeholder="Type a message… (Ctrl+Enter to send)"></textarea>
    <div style="display:flex;flex-direction:column;gap:10px">
      <label><input type="checkbox" id="attach"> attach snapshot tarball</label>
      <button id="send">Send</button>
      <div id="status" class="chip">idle</div>
    </div>
  </div>
<script>
const SNAPSHOT_LATEST_PATH = '/receipts/snapshot_latest.json';
const CHECKPOINT_PATH = '/receipts/sr_watch_checkpoint_v0_1.json';
const INGEST_URL = localStorage.getItem('sr_ingest_url') || 'http://localhost:8891/build';
async function fetchJSON(p){ const r=await fetch(p,{cache:'no-store'}); if(!r.ok) throw new Error(r.status); return r.json(); }
async function loadSnapshotLatest(){ try{ const j=await fetchJSON(SNAPSHOT_LATEST_PATH); window._latest=j; document.getElementById('snapshot').textContent='snapshot: '+(j.path||'').split('/').pop(); }catch{ document.getElementById('snapshot').textContent='snapshot: none'; window._latest=null; } }
async function loadCheckpoint(){ try{ const j=await fetchJSON(CHECKPOINT_PATH); const v=j.verdict||'n/a'; const tag=document.getElementById('ckpt'); tag.textContent='checkpoint: '+v; tag.className='chip '+(v==='foedus_intactum'?'ok':'err'); }catch{ document.getElementById('ckpt').textContent='checkpoint: n/a'; } }
async function sendMessage(){
  const st=document.getElementById('status'); st.textContent='preparing…';
  const text=document.getElementById('msg').value.trim();
  const payload={schema:'sr.message.v0_1', when:new Date().toISOString(), text, snapshot: window._latest||null};
  const fd=new FormData();
  fd.append('message.json', new Blob([JSON.stringify(payload)],{type:'application/json'}), 'message.json');
  if(document.getElementById('attach').checked && window._latest?.path){
    st.textContent='fetching snapshot…';
    const snap=await fetch(window._latest.path,{cache:'no-store'}); if(snap.ok){ const blob=await snap.blob(); fd.append('snapshot', blob, (window._latest.path.split('/').pop()||'snapshot.tgz')); }
  }
  st.textContent='sending…';
  const res=await fetch(INGEST_URL,{method:'POST',body:fd});
  st.textContent = res.ok ? 'sent ✓' : ('error '+res.status);
  if(res.ok) document.getElementById('msg').value='';
}
document.getElementById('send').onclick=sendMessage;
document.getElementById('msg').addEventListener('keydown',e=>{ if(e.key==='Enter'&&(e.ctrlKey||e.metaKey)){ e.preventDefault(); sendMessage(); }});
document.getElementById('fullscreen').onclick=()=>document.documentElement.requestFullscreen().catch(()=>{});
let wl=null; document.getElementById('wake').onclick=async function(){ try{ if(!wl){ wl=await navigator.wakeLock.request('screen'); this.textContent='WakeLock ✓'; } else { await wl.release(); wl=null; this.textContent='WakeLock'; } }catch{} }
loadSnapshotLatest(); loadCheckpoint(); setInterval(loadCheckpoint, 5000);
</script></body></html>
