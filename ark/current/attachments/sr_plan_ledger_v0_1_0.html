<!doctype html>
<html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Plan Ledger — v0.1.0</title>
<style>
:root{ --bg:#0b0c06; --grid:#1a2b1a; --text:#b4ffb4; --ok:#39ff14; --bad:#ff6b6b; --warn:#ffd166 }
html,body{margin:0;background:#0b0c06;color:#b4ffb4;font-family:ui-monospace,Consolas,monospace}
.wrap{max-width:1000px;margin:0 auto;padding:12px}
.card{border:1px solid var(--grid);border-radius:12px;background:#0f140f;padding:12px;margin-top:10px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0}
input,button,textarea{border:1px solid var(--grid);background:#0a0f0a;color:#b4ffb4;border-radius:8px;padding:8px}
button{cursor:pointer}
.small{font-size:12px;color:#9ae89a}
pre{white-space:pre-wrap;word-break:break-word;font-size:12px;line-height:1.35;max-height:260px;overflow:auto}
table{width:100%;border-collapse:collapse;font-size:12px;margin-top:8px} th,td{border-bottom:1px solid var(--grid);padding:6px;vertical-align:top}
</style>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="small">Static Rooster • Plan Ledger v0.1.0</div>
  <div class="card">
    <div class="row">
      <input type="file" id="prev" accept=".zip">
      <input type="file" id="next" accept=".zip">
      <button id="btnDiff">Compare Dossiers</button>
    </div>
  </div>
  <div class="card">
    <div class="small">Diff summary</div>
    <pre id="sum">—</pre>
    <div class="small">Changes</div>
    <table id="tbl"><thead><tr><th>Kind</th><th>Detail</th></tr></thead><tbody></tbody></table>
  </div>
</div>
<script>
async function readZipJSON(zip, name){ const f = zip.file(name); if(!f) return null; try{ return JSON.parse(await f.async('string')); }catch(_){ return null; } }
function byId(id){ return document.getElementById(id); }
document.getElementById('btnDiff').onclick = async ()=>{
  const p = document.getElementById('prev').files[0], n = document.getElementById('next').files[0];
  if(!p || !n) return alert('Pick two dossier zips');
  const zp = await JSZip.loadAsync(p), zn = await JSZip.loadAsync(n);
  const dp = await readZipJSON(zp, 'dossier.json'), dn = await readZipJSON(zn, 'dossier.json');
  const pp = await readZipJSON(zp, 'por.json'), pn = await readZipJSON(zn, 'por.json');
  const sp = await readZipJSON(zp, 'sprint_plan.json'), sn = await readZipJSON(zn, 'sprint_plan.json');
  const changes=[];
  if(dp?.checksums?.attachments_manifest_sha256 !== dn?.checksums?.attachments_manifest_sha256) changes.push({k:'attachments', d:'attachments changed'});
  if(dp?.checksums?.sprint_sha256 !== dn?.checksums?.sprint_sha256) changes.push({k:'sprint_plan', d:'sprint plan changed'});
  if((dp?.seal||'') !== (dn?.seal||'')) changes.push({k:'seal', d:`${dp?.seal||'(none)'} → ${dn?.seal||'(none)'}`});
  // crude sprint-level task completion diff
  if(sp && sn){
    const mapP = new Map((sp.sprints||[]).map(s=>[s.id, s]));
    const mapN = new Map((sn.sprints||[]).map(s=>[s.id, s]));
    for(const [id, sN] of mapN){
      const sP = mapP.get(id);
      if(!sP) { changes.push({k:'sprint_added', d:id}); continue; }
      const doneP = (sP.tasks||[]).filter(t=>t.done).map(t=>t.id);
      const doneN = (sN.tasks||[]).filter(t=>t.done).map(t=>t.id);
      const newDone = doneN.filter(x=>!doneP.includes(x));
      if(newDone.length) changes.push({k:'tasks_done', d:`${id}: +${newDone.join(', ')}`});
    }
  }
  byId('sum').textContent = `Changes detected: ${changes.length}`;
  const tb=document.querySelector('#tbl tbody'); tb.innerHTML=''; changes.forEach(c=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.k}</td><td>${c.d}</td>`; tb.appendChild(tr); });
};
</script>
</body></html>
